<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPECTRA X — IA de Sinais</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0b13; --panel:#101021; --stroke:#24243a;
  --text:#eef2ff; --muted:#9aa3b2; --neon:#9f5bff; --neon2:#00b3ff;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#151536;
  --shadow:0 10px 30px rgba(0,0,0,.45);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;color:var(--text);font:400 14px/1.55 Inter,system-ui,Arial;
  background:
    radial-gradient(1200px 800px at 15% -10%, rgba(159,91,255,.10), transparent 60%),
    radial-gradient(900px 700px at 120% 10%, rgba(0,179,255,.10), transparent 60%),
    var(--bg);
}
.wrap{max-width:1280px;margin:22px auto;padding:0 16px}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
  border:1px solid var(--stroke);border-radius:16px;padding:14px;
  backdrop-filter: blur(8px);box-shadow: var(--shadow);
}
.title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
.btn{background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:0;color:#fff;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 14px rgba(139,92,246,.25);transition:.15s transform ease}
.btn:hover{transform:translateY(-1px)}
.btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text);font-weight:700}
.seg{display:flex;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
.seg button{background:transparent;color:var(--text);padding:8px 12px;border:0;cursor:pointer}
.seg button.active{background:var(--neon);color:#0b0b13;font-weight:900}
.row{display:grid;gap:16px}
.g3{grid-template-columns:1.2fr .8fr 1fr}
@media (max-width:1200px){.g3{grid-template-columns:1fr}}

.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.summary{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.summary .pill{background:rgba(21,21,38,.7);border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;font-weight:800}
.health{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.health .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(21,21,38,.7)}
.badge.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.15)}
.badge.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.15)}
.badge.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.15)}

/* Painel IA central */
.neural-banner{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:stretch;
  border:1px solid var(--stroke);border-radius:18px;padding:16px;
  background:linear-gradient(180deg, rgba(159,91,255,.07), rgba(0,0,0,0));position:relative}
.header-line{display:flex;gap:10px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.q-badge{padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(21,21,38,.7);font-weight:800}
.q-badge.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
.q-badge.mid{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
.q-badge.low{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
.timer{font-weight:900;padding:4px 10px;border:1px solid var(--stroke);border-radius:999px;background:rgba(21,21,38,.7);min-width:64px;text-align:center}

.left{display:grid;place-items:center}
.brain{width:100%;max-width:320px;aspect-ratio:1/1;border-radius:50%;display:grid;place-items:center;position:relative}

/* Anel do estado */
.ring{
  position:absolute;inset:7.5%;border-radius:50%;
  background:conic-gradient(from 90deg,#60a5fa,#a78bfa,#60a5fa,#a78bfa 98%,#60a5fa);
  -webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 10px),#000 calc(100% - 10px));
          mask:radial-gradient(farthest-side,transparent calc(100% - 10px),#000 calc(100% - 10px));
}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes breathe{0%{box-shadow:0 0 0 rgba(0,255,204,0)}50%{box-shadow:0 0 18px rgba(0,255,204,.35)}100%{box-shadow:0 0 0 rgba(0,255,204,0)}}
@keyframes danger{0%{box-shadow:0 0 0 rgba(239,68,68,0)}50%{box-shadow:0 0 16px rgba(245,158,11,.35),0 0 26px rgba(239,68,68,.25)}100%{box-shadow:0 0 0 rgba(239,68,68,0)}}
.ring--idle{} .ring--spin{animation:spin 12s linear infinite} .ring--open{animation:breathe 2.4s ease-in-out infinite} .ring--gale{animation:danger 2s ease-in-out infinite}

.brain-core{text-align:center;display:grid;place-items:center}
.disc{position:absolute;inset:calc(7.5% + 10px);border-radius:50%;box-shadow:inset 0 0 24px rgba(0,0,0,.25),0 8px 24px rgba(0,0,0,.25)}
.disc.red{background:linear-gradient(180deg,#ff3856,#b31830)}
.disc.black{background:linear-gradient(180deg,#10151b,#0a0d12)}
.disc.white{background:linear-gradient(180deg,#fff,#e9ebef);border:1px solid #d9d9d9}
.pct{font-size:18px;opacity:.92;font-weight:800;z-index:1;display:none}
.pct.show{display:block}
.await{margin-top:10px;font-size:13px;color:var(--muted);text-align:center;display:none;opacity:0;transition:opacity .25s ease}
.await.show{display:block;opacity:1}

.right{display:grid;gap:10px}
.item{background:rgba(21,21,38,.7);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.item-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.item-value{font-weight:900}
.ball{min-width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-weight:900;border:1px solid var(--stroke);box-shadow:0 6px 12px rgba(0,0,0,.25)}
.ball.R{background:#ff2b46}.ball.B{background:#0f1117}.ball.W{background:#fff;color:#111;border-color:#ddd}
.scroll{display:flex;gap:8px;overflow:auto;padding:6px 2px}

/* Estatísticas */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
.table td{padding:10px 8px;background:rgba(21,21,38,.7);border:1px solid var(--stroke)}
.table td:first-child{border-radius:10px 0 0 10px}
.table td:last-child{border-radius:0 10px 10px 0}
.pl-pos{color:#7ee787;font-weight:800}
.pl-neg{color:#ff7b72;font-weight:800}

/* Coach */
.coach{display:grid;gap:10px}
.card{background:rgba(21,21,38,.7);border:1px solid var(--stroke);border-radius:12px;padding:12px}
.card h3{margin:0 0 6px 0;font-size:14px;color:var(--muted);font-weight:700}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv .tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(21,21,38,.7);font-weight:800}
.tag.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.15)}
.tag.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.15)}
.tag.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.15)}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <h1>SPECTRA X — IA de Sinais</h1>
      <div class="summary">
        <span class="pill" id="state-pill">OFFLINE • —</span>
        <div class="seg">
          <button type="button" class="active" id="mode-cores">CORES</button>
          <button type="button" id="mode-branco">BRANCO</button>
        </div>
        <button type="button" class="btn" id="btn-start">Iniciar</button>
        <button type="button" class="btn ghost" id="btn-stop">Parar</button>
      </div>
      <div class="health">
        <span id="data-src" class="badge">Fonte: —</span>
        <span id="lat-badge" class="badge">Latência —</span>
        <span id="live-badge" class="badge">Live —</span>
        <button type="button" class="btn ghost" id="btn-api">API</button>
      </div>
    </div>
  </div>

  <div class="row g3" style="margin-top:14px">
    <div class="panel">
      <div class="neural-banner">
        <div class="left">
          <div class="header-line">
            <span id="quality-badge" class="q-badge">Qualidade —</span>
            <span id="market-badge" class="q-badge">Mercado —</span>
            <span id="round-timer" class="timer">--:--</span>
          </div>
          <div class="brain">
            <div id="ring" class="ring ring--idle"></div>
            <div class="brain-core">
              <div class="disc" id="tgt-disc"></div>
              <div class="pct" id="banner-pct">—%</div>
            </div>
          </div>
          <div id="await-label" class="await">Aguardando novo sinal…</div>
        </div>

        <div class="right">
          <div class="item"><div class="item-title">IA — Recomendação</div><div class="item-value" id="meta-rec">—</div></div>
          <div class="item"><div class="item-title">Alvo atual</div><div class="item-value" id="meta-target">—</div></div>
          <div class="item"><div class="item-title">Confluência</div><div class="item-value" id="meta-conf">—</div></div>
          <div class="item"><div class="item-title">Gales</div><div class="item-value" id="gales-max">—</div></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="title"><strong>Últimos giros</strong></div>
      <div id="rolls" class="scroll"></div>
    </div>

    <div class="panel">
      <div class="title"><strong>Coach & Saúde</strong></div>
      <div class="coach">
        <div class="card">
          <h3>Resumo</h3>
          <div class="kv">
            <span class="tag" id="tag-winrate">Winrate 60: —</span>
            <span class="tag" id="tag-entropy">Entropia: —</span>
            <span class="tag" id="tag-market">Mercado: —</span>
          </div>
        </div>
        <div class="card">
          <h3>Dicas</h3>
          <div id="coach-msg">Aguardando leituras da IA…</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <div class="title"><strong>Estatísticas por estratégia</strong></div>
    <table class="table" id="stat-table">
      <thead><tr>
        <th>Estratégia</th><th>Entradas</th><th>WIN</th><th>LOSS</th><th>Assert.</th><th>P/L (sim.)</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const API = (localStorage.getItem('API_BASE') || location.origin).replace(/\/+$/,'');
const $ = s => document.querySelector(s);

let lastHistLen=0,lastSpinAt=Date.now(),spinMs=12000,hadOpen=false,lastMode='CORES';

setInterval(()=>{
  const el=$('#round-timer'); if(!el) return;
  const now=Date.now(),remain=Math.max(0,lastSpinAt+spinMs-now);
  const sec=Math.ceil(remain/1000),mm=Math.floor(sec/60),ss=(sec%60).toString().padStart(2,'0');
  el.textContent=`${mm}:${ss}`;
},250);

function setActiveModeButton(m){
  const c=$('#mode-cores'),b=$('#mode-branco');
  if(m==='CORES'){c.classList.add('active');b.classList.remove('active');}
  else{b.classList.add('active');c.classList.remove('active');}
  lastMode=m;
}

document.getElementById('btn-api').onclick = () => {
  const cur = localStorage.getItem('API_BASE') || location.origin;
  const val = prompt('URL do backend (ex: http://127.0.0.1:5000 ou https://seu-tunel.ngrok.app)', cur);
  if (!val) return;
  localStorage.setItem('API_BASE', val.replace(/\/+$/,''));
  location.reload();
};

$('#mode-cores').onclick=()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'CORES'})}).then(()=>setActiveModeButton('CORES')).catch(e=>alert('Erro ao setar modo CORES: '+e));
$('#mode-branco').onclick=()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'BRANCO'})}).then(()=>setActiveModeButton('BRANCO')).catch(e=>alert('Erro ao setar modo BRANCO: '+e));

document.getElementById('btn-start').onclick = async () => {
  try{
    const r=await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:true})});
    if(!r.ok) throw new Error('HTTP '+r.status);
    $('#state-pill').textContent='ONLINE • '+lastMode;
  }catch(e){ alert('Falha ao ligar: '+e.message+'\nAPI='+API+'/control'); }
};
document.getElementById('btn-stop').onclick = async () => {
  try{
    const r=await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:false})});
    if(!r.ok) throw new Error('HTTP '+r.status);
    hardResetUI('OFFLINE • '+lastMode);
  }catch(e){ alert('Falha ao parar: '+e.message+'\nAPI='+API+'/control'); }
};

function ball(n){
  if(n===0) return `<div class="ball W">0</div>`;
  const c=(n>=1&&n<=7)?'R':'B';
  return `<div class="ball ${c}">${n}</div>`;
}
function ballStrip(seq){return (seq||[]).slice(-14).map(n=>ball(n)).join('');}

function setTargetVisual(t){
  const d=$('#tgt-disc'); d.className='disc';
  if(t==='W') d.classList.add('white');
  else if(t==='R') d.classList.add('red');
  else if(t==='B') d.classList.add('black');
}
function computeQuality(o,p){
  const c=o?.confluence??0,m=o?.max_gales??0,pr=Number(p?.rec?.p||0);
  let s=(pr*0.6)+(c*6)-(m*8);
  s=Math.max(0,Math.min(100,Math.round(s)));
  const l=s>=70?'Alta':s>=45?'Média':'Baixa';
  return{score:s,label:l};
}
function setQualityBadge(q){
  const el=$('#quality-badge');
  el.className='q-badge '+(q.score>=70?'good':q.score>=45?'mid':'low');
  el.textContent=`Qualidade: ${q.label} • ${q.score}%`;
}
function setMarketBadge(j){
  const el=$('#market-badge');
  if(j.market_bad){ el.className='q-badge low'; el.textContent='Mercado: Ruim'; }
  else{ el.className='q-badge good'; el.textContent='Mercado: OK'; }
}
function setGalesMax(o){
  const el=$('#gales-max');
  if(!o){el.textContent='—';return;}
  const m=o.max_gales||0; el.textContent=m===1?'até 1 gale':`até ${m} gales`;
}
function showPct(f){$('#banner-pct').classList.toggle('show',!!f);}
function showAwait(flag){$('#await-label').classList.toggle('show',!!flag);}

function resetSignalUI(){
  const d=$('#tgt-disc'); d.className='disc';
  $('#banner-pct').textContent='—%'; showPct(false);
  $('#meta-target').textContent='—'; $('#meta-conf').textContent='—';
  $('#gales-max').textContent='—'; $('#meta-rec').textContent='—';
  const q=$('#quality-badge'); q.className='q-badge'; q.textContent='Qualidade —';
  $('#ring').className='ring ring--idle'; showAwait(true);
}
function hardResetUI(txt){ resetSignalUI(); $('#state-pill').textContent=txt??$('#state-pill').textContent; }

function setBannerFrom(o,p){
  if(!o){ resetSignalUI(); return; }
  showAwait(false);
  const t=o.target, pct=Number(p?.rec?.p||0);
  setTargetVisual(t);
  $('#banner-pct').textContent=`${Math.round(pct*10)/10}%`; showPct(true);
  $('#meta-target').textContent=({W:'BRANCO',R:'VERMELHO',B:'PRETO'})[t]||'—';
  $('#meta-conf').textContent=o.confluence??'—';
  setGalesMax(o);
}
function setPhase(o,p){
  const r=$('#ring'); if(!o){ resetSignalUI(); return; }
  showAwait(false);
  if(o.phase==='analyzing'){
    r.className='ring ring--spin';
    $('#meta-rec').textContent=`Analisando • ${Math.round((p?.rec?.p||0)*10)/10}%`;
    return;
  }
  const g=o.step||0,m=o.max_gales||0; setGalesMax(o);
  if(g===0){ r.className='ring ring--open'; $('#meta-rec').textContent=`Sinal ativo • G0 (até ${m})`; }
  else{ r.className='ring ring--gale'; $('#meta-rec').textContent=`Sinal ativo • GALE ${g}/${m}`; }
}

function updateHealth(j){
  $('#data-src').textContent = `Fonte: ${j.data_source||'—'}`;
  const lat = (j.latency_ms!=null)? `${j.latency_ms} ms` : '—';
  const sec = (j.seconds_since_last!=null)? `${j.seconds_since_last.toFixed(1)}s` : '—';
  const lb = $('#lat-badge'); lb.textContent = `Latência ${lat} • Último ${sec}`;
  const live = $('#live-badge'); live.textContent = j.live_ok? 'Live OK' : 'Atraso na fonte';
  live.className = 'badge ' + (j.live_ok ? 'ok' : 'warn');
}

function renderStats(stats){
  const tb = $('#stat-table tbody');
  const rows = Object.entries(stats||{}).map(([name,v])=>{
    const plClass = (v.pl_sim>=0)?'pl-pos':'pl-neg';
    return `<tr>
      <td>${name}</td><td>${v.entries}</td><td>${v.win}</td><td>${v.loss}</td>
      <td>${v.assert}%</td><td class="${plClass}">${v.pl_sim}</td>
    </tr>`;
  }).join('');
  tb.innerHTML = rows || `<tr><td colspan="6" style="color:var(--muted);text-align:center">Sem dados ainda</td></tr>`;
}

function coachUpdate(j){
  const wr = j.winrate_60;
  const bad = j.market_bad;
  const ent = (j.entropia_alta===true) ? 'Alta' : (j.entropia_alta===false ? 'Ok' : '—');
  const tWr = $('#tag-winrate'); tWr.textContent = `Winrate 60: ${wr!=null?(wr*100).toFixed(1)+'%':'—'}`;
  tWr.className = 'tag '+(wr!=null?(wr>=0.55?'ok':wr>=0.48?'warn':'bad'):'');
  const tEn = $('#tag-entropy'); tEn.textContent = `Entropia: ${ent}`;
  tEn.className = 'tag '+(ent==='Alta'?'warn':'ok');
  const tMk = $('#tag-market'); tMk.textContent = `Mercado: ${bad?'Ruim':'OK'}`;
  tMk.className = 'tag '+(bad?'bad':'ok');

  const coach = $('#coach-msg');
  if(bad){ coach.textContent = '⚠️ Mercado indeciso/ruim. Recomendo pausar e aguardar 8–12 giros estáveis.'; }
  else if(wr!=null && wr<0.5){ coach.textContent = 'Cautela: Winrate abaixo de 50%. Reduza stake temporariamente.'; }
  else{ coach.textContent = '🎯 Cenário estável. Aguarde confluência adequada e latência OK.'; }
}

async function tick(){
  try{
    const r=await fetch(API+'/state');
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j=await r.json();

    $('#state-pill').textContent=`${j.bot_on?'ONLINE':'OFFLINE'} • ${j.mode}`;
    setActiveModeButton(j.mode);
    updateHealth(j);
    renderStats(j.strategy_stats||{});
    setMarketBadge(j);

    const seq=j.last_50||[]; $('#rolls').innerHTML=ballStrip(seq);
    if(seq.length>lastHistLen){
      const now=Date.now(),dt=now-lastSpinAt;
      if(dt>1000&&dt<40000){spinMs=0.7*spinMs+0.3*dt;}
      lastSpinAt=now; lastHistLen=seq.length;
    }

    const currOpen=!!j.open_trade;
    if(hadOpen && !currOpen){ hardResetUI(`${j.bot_on?'ONLINE':'OFFLINE'} • ${j.mode}`); }
    hadOpen=currOpen;

    if(!j.bot_on){ hardResetUI(`OFFLINE • ${j.mode}`); setTimeout(tick,1000); return; }

    const p={rec:{tgt:j.probs.rec.tgt,p:j.probs.rec.p}};
    if(j.open_trade){
      setBannerFrom(j.open_trade,p);
      setPhase(j.open_trade,p);
      const q=computeQuality(j.open_trade,p); setQualityBadge(q);
    }else{
      resetSignalUI();
    }

    // Coach & saúde extra
    const s=await fetch(API+'/stats').then(r=>r.json()).catch(()=>null);
    if(s && s.ok!==false){
      coachUpdate({
        winrate_60: s.winrate_60,
        entropia_alta: s.entropia_alta,
        market_bad: s.mercado_ruim
      });
    }
  }catch(e){
    console.error(e);
    $('#state-pill').textContent='OFFLINE • —';
    $('#live-badge').textContent = 'Conexão falhou';
    $('#live-badge').className = 'badge bad';
    resetSignalUI();
  }finally{
    setTimeout(tick,900);
  }
}

function clearOnFirstLoad(){ $('#rolls').innerHTML=''; resetSignalUI(); }
clearOnFirstLoad(); tick();
</script>
</body>
</html>
