<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPECTRA X — IA de Sinais</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0d0f; --card:#1a1a1d; --stroke:#2a2a2f;
  --text:#f5f6fa; --muted:#9aa3b2;
  --acc:#9f5bff; --acc2:#00b3ff;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,.45);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;color:var(--text);font:400 14px/1.55 Inter,system-ui,Arial;
  background:radial-gradient(1000px 600px at 10% -5%, rgba(159,91,255,.10), transparent 60%),
             radial-gradient(800px 500px at 120% 0%, rgba(0,179,255,.10), transparent 60%),
             var(--bg);
}
.wrap{max-width:1200px;margin:22px auto;padding:0 14px}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
  border:1px solid var(--stroke); border-radius:16px; padding:14px;
  box-shadow:var(--shadow); backdrop-filter: blur(8px);
}
.row{display:grid;gap:14px}
.cols-2{grid-template-columns:2fr 1fr}
.cols-2-50{grid-template-columns:1.2fr .8fr}
@media (max-width:1050px){.cols-2,.cols-2-50{grid-template-columns:1fr}}

.hbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px}
.badge{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.02);font-weight:800}
.btn{background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:0;color:#fff;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 14px rgba(139,92,246,.25);transition:.15s transform ease}
.btn:hover{transform:translateY(-1px)}
.btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text)}
.seg{display:flex;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
.seg button{background:transparent;color:var(--text);padding:8px 12px;border:0;cursor:pointer}
.seg button.active{background:var(--acc);color:#0d0d0f;font-weight:900}

/* ===== VISÃO RÁPIDA ===== */
.quick{display:grid;gap:10px;grid-template-columns:repeat(8,1fr)}
.quick .q{background:rgba(255,255,255,.02);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.quick .title{font-size:12px;color:var(--muted);margin:0 0 4px 0}
.quick .val{font-weight:900;font-size:18px}

/* Entrada agora */
.entry-val{display:flex;align-items:center;gap:8px}
.badge-entry{padding:8px 12px;border-radius:10px;border:1px solid var(--stroke);font-weight:900}
.badge-R{background:#ff2b46;color:#fff}
.badge-B{background:#0f1117;color:#fff}
.badge-W{background:#fff;color:#111;border-color:#ddd}
.tip-muted{color:var(--muted);font-size:12px}

/* ===== GRÁFICO LINHA (assertividade) ===== */
.svg{width:100%;height:260px}
.grid line{stroke:#2a2a2f;stroke-width:1}
.path{fill:none;stroke:url(#grad);stroke-width:2}
.dot{r:2.5;fill:#fff}

/* ===== GRÁFICO PNL ===== */
.svg-pnl{width:100%;height:260px}
.path-pnl{fill:none;stroke:url(#gradp);stroke-width:2}

/* ===== HEATMAP ===== */
.heat-wrap{display:grid;grid-template-columns:repeat(24,1fr);gap:4px}
.cell{height:24px;border-radius:6px;border:1px solid var(--stroke);display:grid;place-items:center;font-size:10px;color:#d8dee9}
.cell small{opacity:.7}

/* ===== ÚLTIMOS GIROS ===== */
.ball{min-width:40px;height:40px;border-radius:10px;display:grid;place-items:center;font-weight:900;border:1px solid var(--stroke)}
.ball.R{background:#ff2b46}.ball.B{background:#0f1117}.ball.W{background:#fff;color:#111;border-color:#ddd}
.scroll{display:flex;gap:6px;overflow:auto;padding:6px 2px}

/* ===== TABELA ===== */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
.table td{padding:10px 8px;background:rgba(255,255,255,.02);border:1px solid var(--stroke)}
.table td:first-child{border-radius:10px 0 0 10px}
.table td:last-child{border-radius:0 10px 10px 0}
.pl-pos{color:#7ee787;font-weight:800}
.pl-neg{color:#ff7b72;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <!-- Top -->
  <div class="card">
    <div class="hbar">
      <div class="brand"><h2 style="margin:0">SPECTRA X — IA de Sinais</h2><span id="state-pill" class="badge">OFFLINE • —</span></div>
      <div class="seg">
        <button type="button" class="active" id="mode-cores">CORES</button>
        <button type="button" id="mode-branco">BRANCO</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btn-start">Iniciar</button>
        <button class="btn ghost" id="btn-stop">Parar</button>
        <button class="btn ghost" id="btn-report">Exportar PDF</button>
        <span id="live-badge" class="badge">Live —</span>
        <span id="lat-badge" class="badge">Latência —</span>
        <button class="btn ghost" id="btn-api">API</button>
      </div>
    </div>
  </div>

  <!-- Visão rápida -->
  <div class="row" style="margin-top:12px">
    <div class="card">
      <div class="quick">
        <div class="q"><div class="title">Assertividade (60)</div><div class="val" id="q-acc">—%</div></div>
        <div class="q"><div class="title">Recomendação</div><div class="val" id="q-rec">—</div></div>
        <div class="q"><div class="title">Mercado</div><div class="val" id="q-mkt">—</div></div>
        <div class="q"><div class="title">Modo</div><div class="val" id="q-mode">—</div></div>
        <div class="q"><div class="title">Probabilidades</div><div class="val" id="q-probs">—</div></div>
        <div class="q">
          <div class="title">Entrada agora</div>
          <div class="val entry-val">
            <span id="q-entry" class="badge-entry">—</span>
            <span id="q-entry-tip" class="tip-muted"></span>
          </div>
        </div>
        <div class="q"><div class="title">Stake sugerida</div><div class="val" id="q-stake">—</div></div>
        <div class="q"><div class="title">Coach</div><div class="val" id="q-coach" style="font-size:14px;line-height:1.3">—</div></div>
      </div>
    </div>
  </div>

  <!-- Análise detalhada 1: assertividade / últimos giros -->
  <div class="row cols-2-50" style="margin-top:12px">
    <div class="card">
      <strong>Variação de assertividade por hora</strong>
      <svg class="svg" viewBox="0 0 800 260" id="chart">
        <defs>
          <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#9f5bff"/><stop offset="100%" stop-color="#00b3ff"/>
          </linearGradient>
        </defs>
        <g class="grid" id="grid"></g>
        <path class="path" id="path" d=""/>
        <g id="dots"></g>
      </svg>
    </div>

    <!-- Últimos giros -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Últimos giros</strong>
        <span class="badge" id="data-src">Fonte: —</span>
      </div>
      <div id="rolls" class="scroll"></div>
      <div style="margin-top:10px"><small style="color:var(--muted)">Dica: se o mercado ficar ruim, o painel mostra alerta “Evite operar”.</small></div>
    </div>
  </div>

  <!-- Análise detalhada 2: PnL / Heatmap / Streaks -->
  <div class="row cols-2" style="margin-top:12px">
    <div class="card">
      <strong>PNL acumulado (simulado)</strong>
      <svg class="svg-pnl" viewBox="0 0 800 260" id="pnlChart">
        <defs>
          <linearGradient id="gradp" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#22c55e"/><stop offset="100%" stop-color="#f59e0b"/>
          </linearGradient>
        </defs>
        <g class="grid" id="pnl-grid"></g>
        <path class="path-pnl" id="pnl-path" d=""/>
        <g id="pnl-dots"></g>
      </svg>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Heatmap por hora (7 dias)</strong>
        <div style="display:flex;gap:8px">
          <span class="badge" id="streak-cur">Streak atual —</span>
          <span class="badge" id="streak-max">Máx WIN/LOSS —</span>
        </div>
      </div>
      <div id="heat" class="heat-wrap"></div>
      <div style="margin-top:8px"><small style="color:var(--muted)">Quanto mais forte a cor, maior a assertividade naquela hora (amostra ≥ 1).</small></div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="row" style="margin-top:12px">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Estatísticas por estratégia</strong>
      </div>
      <table class="table" id="stat-table">
        <thead><tr>
          <th>Estratégia</th><th>Entradas</th><th>WIN</th><th>LOSS</th><th>Assert.</th><th>P/L (sim.)</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API=(localStorage.getItem('API_BASE')||location.origin).replace(/\/+$/,'');
const $=s=>document.querySelector(s);

function ball(n){if(n===0)return`<div class="ball W">0</div>`;const c=(n>=1&&n<=7)?'R':'B';return`<div class="ball ${c}">${n}</div>`;}
function ballStrip(seq){return(seq||[]).slice(-20).map(n=>ball(n)).join('');}
function setActiveModeButton(m){const c=$('#mode-cores'),b=$('#mode-branco');if(m==='CORES'){c.classList.add('active');b.classList.remove('active');}else{b.classList.add('active');c.classList.remove('active');}}
function setEntryBadge(tgt,text){const el=$('#q-entry');el.className='badge-entry';if(!tgt){el.textContent=text||'—';return;}const map={R:'Vermelho',B:'Preto',W:'Branco'};el.textContent=text||map[tgt];el.classList.add('badge-'+tgt);}
function labelFromTarget(tgt){return({R:'Vermelho',B:'Preto',W:'Branco'})[tgt]||'—';}
function renderStats(stats){const tb=$('#stat-table tbody');const rows=Object.entries(stats||{}).map(([n,v])=>{const plClass=(v.pl_sim>=0)?'pl-pos':'pl-neg';return`<tr><td>${n}</td><td>${v.entries}</td><td>${v.win}</td><td>${v.loss}</td><td>${v.assert}%</td><td class="${plClass}">${v.pl_sim}</td></tr>`;}).join('');tb.innerHTML=rows||`<tr><td colspan="6" style="color:var(--muted);text-align:center">Sem dados ainda</td></tr>`;}

function updateQuick(j){
  $('#q-mode').textContent=j.mode||'—';
  $('#q-acc').textContent=j.winrate_60!=null?(j.winrate_60*100).toFixed(1)+'%':'—%';

  const rec=j.probs?.rec; const pr=rec?`${rec.tgt} ${rec.p}%`:'—';
  $('#q-probs').textContent=pr;

  const mktBad=!!j.market_bad;
  $('#q-mkt').textContent=mktBad?'Ruim':'OK';
  $('#q-rec').textContent=j.autopause?'Pausado — revisar mercado':(mktBad?'Evite operar':'Operar com cautela');

  // Entrada agora
  const tip=$('#q-entry-tip');
  if(j.open_trade){
    const t=j.open_trade.target, g=j.open_trade.step||0, m=j.open_trade.max_gales||0, ph=j.open_trade.phase||'';
    const txt=`${labelFromTarget(t)} • ${ph==='open'?(g===0?'G0':`GALE ${g}/${m}`):'analisando'}`;
    setEntryBadge(t,txt); tip.textContent='';
  }else{
    const t=rec?.tgt; const p=Number(rec?.p||0); const confOk=p>=55;
    if(j.autopause){ setEntryBadge(null,'Aguardar'); tip.textContent='Autopause ativo.'; }
    else if(t&&confOk){ setEntryBadge(t,`${labelFromTarget(t)} • ${p}%`); tip.textContent='Recomendação da IA.'; }
    else if(t){ setEntryBadge(null,'Aguardar'); tip.textContent=`Confiança baixa (${p}%).`; }
    else{ setEntryBadge(null,'—'); tip.textContent=''; }
  }

  // stake & coach
  const stk=j.stake_suggested;
  $('#q-stake').textContent = stk ? `R$ ${stk.value} • ${stk.mode}` : '—';
  $('#q-coach').textContent = j.coach || '—';
}

function updateHealth(j){
  const lat=(j.latency_ms!=null)?`${j.latency_ms}ms`:'—';
  const sec=(j.seconds_since_last!=null)?`${j.seconds_since_last.toFixed(1)}s`:'—';
  $('#live-badge').textContent=j.live_ok?'Live OK':'Atraso';
  $('#lat-badge').textContent=`Latência ${lat} • Último ${sec}`;
  $('#data-src').textContent=`Fonte: ${j.data_source||'—'}`;
  if(j.autopause){ $('#state-pill').style.background='rgba(245,158,11,.18)'; }
  else{ $('#state-pill').style.background='rgba(255,255,255,.02)'; }
}

function drawChart(points){
  const path=$('#path'), dots=$('#dots'), grid=$('#grid');
  const W=800,H=260,P=28; const xs=(i,n)=>P+(i*(W-2*P))/Math.max(1,n-1); const ys=(v)=>H-P-v*(H-2*P);
  grid.innerHTML=''; for(let i=0;i<=5;i++){const y=ys(i/5);grid.innerHTML+=`<line x1="${P}" x2="${W-P}" y1="${y}" y2="${y}"/>`;}
  if(!points||!points.length){path.setAttribute('d','');dots.innerHTML='';return;}
  const n=points.length; const d=points.map((p,i)=>`${i?'L':'M'}${xs(i,n)},${ys(p.acc)}`).join(' ');
  path.setAttribute('d',d); dots.innerHTML=points.map((p,i)=>`<circle class="dot" cx="${xs(i,n)}" cy="${ys(p.acc)}"></circle>`).join('');
}

function drawPnl(curve){
  const path=$('#pnl-path'), dots=$('#pnl-dots'), grid=$('#pnl-grid');
  const W=800,H=260,P=28; const xs=(i,n)=>P+(i*(W-2*P))/Math.max(1,n-1);
  if(!curve||!curve.length){path.setAttribute('d','');dots.innerHTML='';grid.innerHTML='';return;}
  // normaliza Y (pnl min..max)
  let min=curve[0].pnl, max=curve[0].pnl;
  for(const c of curve){ if(c.pnl<min)min=c.pnl; if(c.pnl>max)max=c.pnl; }
  if(min===max){ min-=1; max+=1; }
  const ys=(v)=>{ const t=(v-min)/(max-min); return 260-28 - t*(260-56); };
  grid.innerHTML='';
  for(let i=0;i<=4;i++){const y=ys(min + i*(max-min)/4);grid.innerHTML+=`<line x1="28" x2="772" y1="${y}" y2="${y}" class="grid"/>`; }
  const n=curve.length; const d=curve.map((p,i)=>`${i?'L':'M'}${xs(i,n)},${ys(p.pnl)}`).join(' ');
  path.setAttribute('d',d);
  dots.innerHTML=curve.map((p,i)=>`<circle class="dot" cx="${xs(i,n)}" cy="${ys(p.pnl)}"></circle>`).join('');
}

function drawHeatmap(items){
  const wrap=$('#heat'); wrap.innerHTML='';
  if(!items||!items.length){wrap.textContent='Sem dados.';return;}
  items.forEach(it=>{
    const a=it.acc; const n=it.n; // 0..1
    const alpha = Math.max(0.12, Math.min(0.92, a)); // intensidade
    const bg = `linear-gradient(180deg, rgba(159,91,255,${alpha}), rgba(0,179,255,${alpha*0.75}))`;
    const label = n>0 ? `${Math.round(a*100)}%` : '—';
    const cell = document.createElement('div');
    cell.className='cell';
    cell.style.background = bg;
    cell.innerHTML = `<small>${String(it.hour).padStart(2,'0')}h</small>`;
    cell.title = `Hora ${it.hour}: ${label} (${n} entradas)`;
    wrap.appendChild(cell);
  });
}

async function loadChart(){const r=await fetch(API+'/history');const j=await r.json();if(j&&j.points)drawChart(j.points);}
async function loadPerformance(){
  const r=await fetch(API+'/performance'); const j=await r.json();
  if(!j||!j.ok) return;
  drawPnl(j.pnl_curve||[]);
  drawHeatmap(j.hour_heatmap||[]);
  const cur=j.streaks?.current; const mw=j.streaks?.max_win||0; const ml=j.streaks?.max_loss||0;
  $('#streak-cur').textContent = cur?.side ? `Streak atual: ${cur.side} ${cur.len}` : 'Streak atual —';
  $('#streak-max').textContent = `Máx: WIN ${mw} • LOSS ${ml}`;
}

async function tick(){
  try{
    const r=await fetch(API+'/state'); const j=await r.json();
    $('#state-pill').textContent=`${j.bot_on?'ONLINE':'OFFLINE'} • ${j.mode}`;
    setActiveModeButton(j.mode);
    updateHealth(j);
    updateQuick(j);
    renderStats(j.strategy_stats||{});
    $('#rolls').innerHTML=ballStrip(j.last_50||[]);
  }catch(e){
    console.error(e);
    $('#state-pill').textContent='OFFLINE • —';
  }finally{
    setTimeout(tick,1000);
  }
}

document.getElementById('btn-api').onclick=()=>{const cur=localStorage.getItem('API_BASE')||location.origin;const val=prompt('URL do backend (ex: http://127.0.0.1:5000)',cur);if(!val)return;localStorage.setItem('API_BASE',val.replace(/\/+$/,''));location.reload();};
document.getElementById('btn-report').onclick=()=>window.open(API+'/report','_blank');
$('#mode-cores').onclick=()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'CORES'})}).then(()=>setActiveModeButton('CORES'));
$('#mode-branco').onclick=()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'BRANCO'})}).then(()=>setActiveModeButton('BRANCO'));
document.getElementById('btn-start').onclick=()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:true})}).then(()=>$('#state-pill').textContent='ONLINE • '+($('#mode-branco').classList.contains('active')?'BRANCO':'CORES'));
document.getElementById('btn-stop').onclick =()=>fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:false})}).then(()=>$('#state-pill').textContent='OFFLINE • '+($('#mode-branco').classList.contains('active')?'BRANCO':'CORES'));

document.addEventListener('DOMContentLoaded',()=>{tick();loadChart();loadPerformance();});
</script>
</body>
</html>
