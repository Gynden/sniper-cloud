<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spectra X — Neural Trader (Classic)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0b13;--panel:#111122;--card:#151527;--stroke:#23243a;--text:#eef2ff;--muted:#9aa3b2;--neon:#9f5bff;--neon2:#00b3ff;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;color:var(--text);
    background:radial-gradient(1000px 500px at -10% -20%, rgba(159,91,255,.15), transparent 60%),
               radial-gradient(900px 600px at 110% -10%, rgba(0,179,255,.12), transparent 50%),var(--bg)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 210deg,var(--neon),var(--neon2),var(--neon))}
  .brand h1{font-size:20px;margin:0;font-weight:800}
  .status{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:#14162a;border:1px solid var(--stroke);border-radius:999px;padding:8px 12px;display:inline-flex;gap:8px;align-items:center}
  main{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#151527,#121227);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 12px 0;font-size:15px}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(10,1fr);border-radius:14px;border:1px dashed var(--stroke);padding:10px;background:#0d1022}
  .ball{height:34px;border-radius:10px;border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center;font-weight:800;background:#0a0d1a}
  .b-red{color:#ff7a7a}.b-black{color:#cbd5e1}.b-white{color:#9f5bff;border:1px solid rgba(159,91,255,.6)}
  .progress{height:12px;background:#0c0f1f;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--neon),var(--neon2))}
  .tag{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--stroke);font-size:13px} th{text-align:left}
  .pill{display:inline-flex;align-items:center;padding:6px 14px;border-radius:999px;background:#0e1021;border:1px solid var(--stroke);gap:8px;font-weight:800}
  button{width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:900;background:linear-gradient(135deg,rgba(159,91,255,.95),rgba(0,179,255,.9));color:#fff}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:700px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:#0e1021;border:1px solid var(--stroke);border-radius:14px;padding:14px}
  .kpi .v{font-size:22px;font-weight:900}.kpi .l{font-size:12px;color:var(--muted)}
  .bigBadge{font-size:28px}
  .gaGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:700px){.gaGrid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="logo"></div><h1>Spectra X — Neural Trader (Classic)</h1></div>
    <div class="status">
      <span class="chip" id="apiChip">API: <b id="apiStatus">Offline</b></span>
      <span class="chip">Stake: R$ <b id="stakeLabel">2.00</b></span>
      <span class="chip">Gales: <b id="galesLabel">2</b></span>
      <span class="chip">Winrate: <b id="wrLabel">0%</b></span>
    </div>
  </header>

  <main>
    <section class="card col">
      <h2>Últimas Rodadas & Probabilidades</h2>
      <div class="grid" id="lastGrid"></div>
      <div style="margin-top:12px" class="row">
        <div class="col"><div class="pill">Red prob</div><div class="progress"><i id="pRed"></i></div><span class="tag" id="pRedTxt">0%</span></div>
        <div class="col"><div class="pill">Black prob</div><div class="progress"><i id="pBlack"></i></div><span class="tag" id="pBlackTxt">0%</span></div>
        <div class="col"><div class="pill">White prob</div><div class="progress"><i id="pWhite"></i></div><span class="tag" id="pWhiteTxt">0%</span></div>
      </div>
      <div style="margin-top:12px" class="kpis">
        <div class="kpi"><div class="v" id="sigTotal">0</div><div class="l">Sinais</div></div>
        <div class="kpi"><div class="v" id="wins">0</div><div class="l">Wins</div></div>
        <div class="kpi"><div class="v" id="losses">0</div><div class="l">Losses</div></div>
        <div class="kpi"><div class="v" id="bank">R$ 0,00</div><div class="l">Resultado</div></div>
      </div>
    </section>

    <section class="card col">
      <h2>Entrada Recomendada</h2>
      <div id="entryBox" style="display:flex;flex-direction:column;gap:12px">
        <div class="pill bigBadge" id="entryBadge">—</div>
        <div class="tag" id="entrySource">Fonte: —</div>
        <div>
          <div class="progress"><i id="entryBar"></i></div>
          <span class="tag" id="entryConf">confiança: 0%</span>
        </div>
        <button id="confirmBtn" disabled>Confirmar entrada (Enter)</button>
        <div class="row" style="margin-top:6px">
          <div class="col"><div class="kpi"><div class="v" id="sigGale">—</div><div class="l">Gale (atual / máx)</div></div></div>
          <div class="col"><div class="kpi"><div class="v" id="sigStatus">—</div><div class="l">Status</div></div></div>
        </div>
      </div>
    </section>

    <!-- Painel Auto-Strategy (GA) -->
    <section class="card col">
      <h2>Auto-Strategy (GA)</h2>
      <div class="gaGrid">
        <div class="kpi"><div class="v" id="gaActive">—</div><div class="l">Ativa (id)</div></div>
        <div class="kpi"><div class="v" id="gaType">—</div><div class="l">Tipo</div></div>
        <div class="kpi"><div class="v" id="gaScore">—</div><div class="l">Score</div></div>
        <div class="kpi"><div class="v" id="gaGen">—</div><div class="l">Geração</div></div>
        <div class="kpi"><div class="v" id="gaPool">—</div><div class="l">Pool</div></div>
        <div class="kpi"><div class="v" id="gaSource">—</div><div class="l">Fonte do Sinal</div></div>
      </div>
    </section>

    <section class="card col" style="grid-column:1 / -1">
      <h2>Histórico de Operações</h2>
      <table>
        <thead><tr><th>Horário</th><th>Entrada</th><th>Confiança</th><th>Gales</th><th>Resultado</th></tr></thead>
        <tbody id="opsBody"></tbody>
      </table>
    </section>
  </main>
</div>

<script>
  // ===== Seleção da API (tecla 'A' para trocar) =====
  const API_KEY = 'SPECTRA_API';
  const getApiBase = () => (localStorage.getItem(API_KEY) || window.location.origin).replace(/\/+$/,'');
  async function askApi(){ const v=prompt('URL da API (ex.: https://sniperblaze-cloud.onrender.com)', getApiBase()); if(v){ localStorage.setItem(API_KEY, v.replace(/\/+$/,'')); location.reload(); } }
  window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='a') askApi(); });
  let API = getApiBase();
  document.getElementById('apiChip').title = 'Pressione A para trocar a URL da API';

  const $=(id)=>document.getElementById(id);
  const money=v=>"R$ "+(v||0).toFixed(2).replace(".",",");
  async function j(path,opts){ const r=await fetch(API+path,opts); return await r.json(); }

  function renderBalls(arr){
    const g=$("lastGrid"); g.innerHTML="";
    arr.slice(-10).forEach(c=>{
      const b=document.createElement("div");
      b.className="ball "+(c==="red"?"b-red":c==="black"?"b-black":"b-white");
      b.textContent=c==="white"?"W":(c==="red"?"R":"B"); g.appendChild(b);
    });
  }

  // Atualiza as barras de probabilidade com base em s.active_signal.probs (Spectra)
  function setProbs(probs){
    const pr = Math.round(((probs?.red)||0)*100);
    const pb = Math.round(((probs?.black)||0)*100);
    const pw = Math.round(((probs?.white)||0)*100);
    $("pRed").style.width = pr+"%";   $("pRedTxt").textContent = pr+"%";
    $("pBlack").style.width = pb+"%"; $("pBlackTxt").textContent = pb+"%";
    $("pWhite").style.width = pw+"%"; $("pWhiteTxt").textContent = pw+"%";
  }

  function setEntry(color,conf,gale,maxg,status,confirmed,source,probs){
    const badge=$("entryBadge");
    if(!color){
      badge.textContent="—";
      $("entryBar").style.width="0%";
      $("entryConf").textContent="confiança: 0%";
      $("confirmBtn").disabled=true;
      $("sigGale").textContent="—";
      $("sigStatus").textContent="—";
      $("entrySource").textContent = "Fonte: —";
      setProbs(null);
      return;
    }
    badge.textContent=`ENTRAR: ${color.toUpperCase()}`;
    $("entryBar").style.width=Math.round(conf*100)+"%";
    $("entryConf").textContent="confiança: "+Math.round(conf*100)+"%";
    $("sigGale").textContent=(gale||0)+"/"+(maxg||0);
    $("sigStatus").textContent=confirmed?"confirmado":(status||"—");
    $("confirmBtn").disabled=confirmed||status!=="running";
    $("confirmBtn").textContent = confirmed ? "Confirmado ✓" : "Confirmar entrada (Enter)";
    $("entrySource").textContent = "Fonte: " + (source || "—");
    // Probs: só preenche quando vier do Spectra (red/black/white). Em GA, mostra 0/0/0.
    setProbs(source==="spectra_ai" ? probs : null);
  }

  function row(op){
    const tr=document.createElement("tr");
    const t=new Date(op.created_at||Date.now()).toLocaleTimeString();
    tr.innerHTML=`<td>${t}</td><td><span class="pill">${(op.color||"").toUpperCase()}</span></td>
      <td>${((op.confidence||0)*100).toFixed(0)}%</td><td>${op.gale_step||0}/${op.max_gales||0}</td>
      <td>${op.result ? (op.result==="WIN"?"✅ WIN":"❌ LOSS") : (op.confirmed?"✓ Confirmado":"—")}</td>`;
    return tr;
  }
  let lastFinishedId=null;
  function maybeAppendFinished(op){ if(!op||!op.result)return; const id=op.created_at; if(id&&id!==lastFinishedId){$("opsBody").prepend(row(op)); lastFinishedId=id;} }

  async function refresh(){
    // health primeiro (para status)
    try{ await j(`/api/health`); $("apiStatus").textContent="Online"; }catch(e){ $("apiStatus").textContent="Offline"; return; }
    try{
      const s=await j(`/api/state`);
      $("stakeLabel").textContent=(s.config?.stake||2).toFixed(2);
      $("galesLabel").textContent=s.config?.max_gales||2;
      $("sigTotal").textContent=s.metrics?.total_signals||0;
      $("wins").textContent=s.metrics?.wins||0;
      $("losses").textContent=s.metrics?.losses||0;
      $("bank").textContent=money(s.metrics?.bank_result||0);
      $("wrLabel").textContent=Math.round((s.metrics?.winrate||0)*100)+"%";
      renderBalls(s.history_tail||[]);

      // Auto-Strategy dashboard
      const ga = s.auto_strategy || {};
      const active = ga.active || null;
      $("gaActive").textContent = active ? (active.id || "—") : "—";
      $("gaType").textContent = active ? (active.type || "—") : "—";
      $("gaScore").textContent = ga.active_score!=null ? String(ga.active_score) : "—";
      $("gaGen").textContent = ga.generation!=null ? String(ga.generation) : "—";
      $("gaPool").textContent = ga.pool_size!=null ? String(ga.pool_size) : "—";

      const a=s.active_signal;
      // fonte atual do sinal (GA ou Spectra)
      const src = a?.source || (active ? "auto_strategy" : "spectra_ai");
      $("gaSource").textContent = src;

      if(a){
        setEntry(a.color,a.confidence,a.gale_step,a.max_gales,a.status,a.confirmed,src,a.probs);
        if(a.status==="finished"){ maybeAppendFinished(a); }
      } else {
        setEntry(null,0,0,0,"—",false,null,null);
      }
    }catch(e){ $("apiStatus").textContent="Offline"; }
  }

  async function confirmEntry(){
    try{
      const r=await j(`/api/confirm`,{method:"POST"});
      if(r.ok){ refresh(); }
    }catch(e){}
  }
  $("confirmBtn").onclick=confirmEntry;
  window.addEventListener("keydown",e=>{ if(e.key==="Enter" && !$("confirmBtn").disabled){ confirmEntry(); } });

  refresh(); setInterval(refresh,1200);
</script>
</body>
</html>
