<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SNIPER BLAZE — Neural Trader</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b13; --panel:#101021; --glass:#0e0e1a; --stroke:#24243a;
      --text:#eef2ff; --muted:#9aa3b2; --neon:#9f5bff; --neon2:#00b3ff;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#151536;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);font:400 14px/1.55 Inter,system-ui,Arial;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(159,91,255,.10), transparent 60%),
        radial-gradient(900px 700px at 120% 10%, rgba(0,179,255,.10), transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--stroke);border-radius:16px;padding:14px;
      backdrop-filter: blur(8px);box-shadow: var(--shadow);
    }
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .kpi{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;font-weight:800}
    .btn{background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:0;color:#fff;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:0 6px 14px rgba(139,92,246,.25)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text);font-weight:700;box-shadow:none}
    .seg{display:flex;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .seg button{background:transparent;color:var(--text);padding:8px 12px;border:0;cursor:pointer}
    .seg button.active{background:var(--neon);color:#0b0b13;font-weight:900}
    .row{display:grid;gap:16px}
    .g2{grid-template-columns:1.25fr 1fr}
    @media (max-width:1024px){.g2{grid-template-columns:1fr}}

    /* Banner */
    .neural-banner{display:grid;grid-template-columns:1fr 1.2fr;gap:18px;align-items:center;
      border:1px solid var(--stroke);border-radius:18px;padding:18px;
      background:linear-gradient(180deg, rgba(159,91,255,.07), rgba(0,0,0,0));
      position:relative;overflow:hidden}
    .left-col{display:grid;grid-template-rows:auto auto 1fr;gap:10px}
    #confirm-slot{display:flex;justify-content:center;align-items:center;min-height:30px}
    .confirm-badge{
      padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.25);
      background:linear-gradient(90deg,#00ffcc,#9f5bff);color:#0b0b13;font-weight:900;
      font-size:12px;display:none;box-shadow:0 8px 20px rgba(0,255,204,.18)
    }
    .live{position:absolute;right:18px;top:18px;background:var(--ok);color:#06130a;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;animation:pulse 1.6s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.45}100%{opacity:1}}
    .brain{width:100%;max-width:300px;aspect-ratio:1/1;margin:auto;border-radius:50%;display:grid;place-items:center;position:relative;}
    .ring{position:absolute;inset:8%;border-radius:50%;
      background:conic-gradient(from 90deg, var(--neon), var(--neon2), var(--neon), var(--neon2));
      -webkit-mask:radial-gradient(farthest-side, transparent calc(100% - 8px), #000 calc(100% - 8px));
              mask:radial-gradient(farthest-side, transparent calc(100% - 8px), #000 calc(100% - 8px));
      animation:spin 9s linear infinite;filter:drop-shadow(0 0 10px rgba(159,91,255,.35))}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ring--idle{opacity:.6}
    .ring--open{filter:drop-shadow(0 0 16px rgba(0,255,204,.35))}
    .ring--gale{background:conic-gradient(from 90deg,#f59e0b,#ef4444,#f59e0b,#ef4444)}
    .brain-core{text-align:center;display:grid;place-items:center;padding:8px 10px}
    .swatch{width:clamp(44px,6vw,64px);height:clamp(44px,6vw,64px);border-radius:50%;border:2px solid rgba(255,255,255,.22);box-shadow:0 6px 14px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.06);margin-bottom:8px}
    .swatch.red{background:#ff2b46}.swatch.black{background:#0b0f14}.swatch.white{background:#fff;border-color:#d9d9d9;box-shadow:0 6px 14px rgba(0,0,0,.25), inset 0 0 10px rgba(0,0,0,.05)}
    .brain-core .pct{font-size:clamp(14px,1.8vw,18px);opacity:.92}
    .meta{display:grid;gap:10px}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .tag{padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);font-size:12px}
    .muted{color:var(--muted)}
    .scroll{display:flex;gap:8px;overflow:auto;padding:6px 2px}
    .ball{min-width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-weight:900;border:1px solid var(--stroke);box-shadow:0 6px 12px rgba(0,0,0,.25)}
    .ball.R{background:#ff2b46}.ball.B{background:#0f1117}.ball.W{background:#fff;color:#111;border-color:#ddd}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .k-card{background:var(--glass);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .k-title{font-size:12px;color:var(--muted)}.k-value{font-size:20px;font-weight:900}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip-mini{border:1px solid var(--stroke);background:rgba(21,21,38,.7);padding:4px 8px;border-radius:999px;font-weight:800;font-size:11px;display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .lab{opacity:.95}
    .hide{display:none!important}

    /* -------- Quick Wins -------- */
    .signal-top{display:flex;gap:10px;align-items:center;justify-content:center}
    .timer{font-weight:900;padding:4px 10px;border:1px solid var(--stroke);
      border-radius:999px;background:rgba(21,21,38,.7);min-width:64px;text-align:center}
    .q-badge{padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);
      background:rgba(21,21,38,.7);font-weight:800}
    .q-badge.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35)}
    .q-badge.mid{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35)}
    .q-badge.low{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}

    .gale-ui{margin-top:6px}
    .gsteps{display:flex;align-items:center;gap:6px}
    .gsteps .step{width:12px;height:12px;border-radius:3px;border:1px solid var(--stroke);background:#1a1b2d}
    .gsteps .step.on{background:#f59e0b;border-color:#f59e0b}
    .gsteps .glabel{margin-left:6px;opacity:.85;font-weight:800}

    .coolbars{display:flex;gap:10px;align-items:center}
    .cool{display:flex;gap:6px;align-items:center}
    .cool span{font-size:12px;color:var(--muted)}
    .cool .bar{width:80px;height:8px;border-radius:999px;background:#1a1b2d;border:1px solid var(--stroke);overflow:hidden}
    .cool .bar i{display:block;height:100%;background:#7aa5ff}
    .cool b{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="title">
        <h1>SNIPER BLAZE — Neural Trader</h1>
        <div class="kpi">
          <span class="chip" id="state-pill">OFFLINE</span>
          <div class="seg">
            <button type="button" class="active" id="mode-cores" title="Modo CORES">CORES</button>
            <button type="button" id="mode-branco" title="Modo BRANCO">BRANCO</button>
          </div>
          <button type="button" class="btn" id="btn-start" title="Iniciar o bot">Iniciar</button>
          <button type="button" class="btn ghost" id="btn-stop" title="Parar o bot">Parar</button>
        </div>
      </div>
    </div>

    <div class="row g2" style="margin-top:14px">
      <div class="panel">
        <div class="title">
          <strong>Motor IA — Próxima Entrada</strong>
          <!-- cooldown visual -->
          <div id="cool-bars" class="coolbars" title="Cooldowns ativos"></div>
        </div>

        <div id="banner" class="neural-banner">
          <div class="left-col">
            <div id="confirm-slot">
              <span class="confirm-badge" id="confirm-badge">ENTRADA CONFIRMADA ✅</span>
            </div>

            <!-- qualidade + timer -->
            <div class="signal-top">
              <span id="quality-badge" class="q-badge" title="Qualidade estimada do sinal">Qualidade —</span>
              <span id="round-timer" class="timer" title="Tempo para o próximo giro">--:--</span>
            </div>

            <div class="brain">
              <div id="ring" class="ring ring--idle"></div>
              <div class="brain-core">
                <div class="swatch" id="tgt-swatch" aria-label="cor alvo"></div>
                <div class="pct" id="banner-pct">—%</div>
              </div>
            </div>
          </div>

          <div class="meta">
            <div class="meta-row"><span class="tag" title="Cor pretendida">Alvo</span><b id="meta-alvo">—</b></div>
            <div class="meta-row"><span class="tag" title="Estratégia representante">Estratégia</span><b id="meta-strategy">—</b></div>
            <div class="meta-row"><span class="tag" title="Total de checks que votaram a favor">Confluência</span><b id="meta-conf">—</b></div>
            <div class="meta-row"><span class="tag" title="Gales usados / permitidos">Gales</span><b id="meta-gales">0/0</b></div>
            <div class="meta-row"><span class="tag" title="Estado do sinal">Status</span><b id="meta-rec">—</b></div>
            <!-- progresso visual de gale -->
            <div id="gale-ui" class="gale-ui" title="Progresso de GALE"></div>
          </div>

          <div class="live" id="live-badge" style="display:none">LIVE</div>
        </div>

        <div class="kpis">
          <div class="k-card"><div class="k-title">WinRate (sessão)</div><div class="k-value" id="k-win">—</div></div>
          <div class="k-card"><div class="k-title">Gales médios</div><div class="k-value" id="k-gales">—</div></div>
          <div class="k-card"><div class="k-title">Sequência atual</div><div class="k-value" id="k-streak">—</div></div>
        </div>
      </div>

      <div class="panel">
        <div class="title">
          <strong>Últimos giros</strong>
        </div>
        <div id="rolls" class="scroll"></div>

        <div id="mini-history" class="card hide" style="margin-top:14px">
          <div class="title">
            <strong>Histórico rápido</strong>
            <span id="hist-counters" class="muted"></span>
          </div>
          <div id="mini-hits" class="chips"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const API = location.origin;
const $ = s => document.querySelector(s);

// ===== timer & rodada (estimação adaptativa) =====
let lastHistLen = 0;
let lastSpinAt = Date.now();
let spinMs = 12000;           // estimativa inicial (~12s)
setInterval(updateTimer, 200);
function updateTimer(){
  const el = $('#round-timer'); if(!el) return;
  const now = Date.now();
  const remain = Math.max(0, lastSpinAt + spinMs - now);
  const sec = Math.ceil(remain/1000);
  const mm = Math.floor(sec/60).toString();
  const ss = (sec%60).toString().padStart(2, '0');
  el.textContent = `${mm}:${ss}`;
}

// ===== Controles =====
function setActiveModeButton(mode){
  const bCores = $('#mode-cores');
  const bBranco = $('#mode-branco');
  if(!bCores || !bBranco) return;
  if(mode === 'CORES'){
    bCores.classList.add('active'); bBranco.classList.remove('active');
  }else{
    bBranco.classList.add('active'); bCores.classList.remove('active');
  }
}

document.getElementById('mode-cores').addEventListener('click', async () => {
  try{
    setActiveModeButton('CORES');
    await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'CORES'})});
  }catch(e){ console.error('modo CORES erro:', e); }
});
document.getElementById('mode-branco').addEventListener('click', async () => {
  try{
    setActiveModeButton('BRANCO');
    await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'BRANCO'})});
  }catch(e){ console.error('modo BRANCO erro:', e); }
});
document.getElementById('btn-start').addEventListener('click', async () => {
  try{
    $('#state-pill').textContent = 'ONLINE • (sincronizando)';
    await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:true})});
  }catch(e){ console.error('start erro:', e); }
});
document.getElementById('btn-stop').addEventListener('click', async () => {
  try{
    $('#state-pill').textContent = 'OFFLINE';
    await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:false})});
  }catch(e){ console.error('stop erro:', e); }
});

// ===== Helpers visuais =====
function ball(n){
  if(n===0) return `<div class="ball W">0</div>`;
  const c=(n>=1&&n<=7)?'R':'B';
  return `<div class="ball ${c}">${n}</div>`;
}
function human(t){ return t==='W'?'Branco':(t==='R'?'Vermelho':'Preto'); }

// swatch no centro do círculo
function setSwatchFromTarget(tgt){
  const sw = $('#tgt-swatch'); if(!sw) return;
  sw.className = 'swatch';
  if(tgt==='W') sw.classList.add('white');
  else if(tgt==='R') sw.classList.add('red');
  else sw.classList.add('black');
}

// cooldown visual
function renderCooldowns(cw, cc){
  const el = $('#cool-bars'); if(!el) return;
  const MW = 5, MC = 2; // limites (coincidem com backend)
  el.innerHTML = `
    <div class="cool" title="Cooldown do Branco">
      <span>Branco</span>
      <div class="bar"><i style="width:${Math.min(100, (cw/MW)*100)}%"></i></div>
      <b>${cw}</b>
    </div>
    <div class="cool" title="Cooldown de Cores">
      <span>Cores</span>
      <div class="bar"><i style="width:${Math.min(100, (cc/MC)*100)}%"></i></div>
      <b>${cc}</b>
    </div>`;
}

// qualidade do sinal
function computeQuality(openTrade, probs){
  const conf = openTrade?.confluence ?? 0;
  const maxg = openTrade?.max_gales ?? 0;
  const p = Number(probs?.rec?.p || 0); // %
  let score = (p*0.6) + (conf*6) - (maxg*8);
  score = Math.max(0, Math.min(100, Math.round(score)));
  const label = score>=70 ? 'Alta' : score>=45 ? 'Média' : 'Baixa';
  return {score, label};
}
function setQualityBadge(q){
  const el = $('#quality-badge'); if(!el) return;
  el.className = 'q-badge ' + (q.score>=70?'good':q.score>=45?'mid':'low');
  el.textContent = `Qualidade: ${q.label} • ${q.score}%`;
}

// progresso de gale
function setGaleUI(openTrade){
  const el = $('#gale-ui'); if(!el) return;
  if(!openTrade){ el.innerHTML=''; return; }
  const step = openTrade.step || 0;
  const max  = openTrade.max_gales || 0;
  let dots = '';
  for(let i=0;i<=max;i++){
    dots += `<span class="step ${i<=step?'on':''}" title="G${i}"></span>`;
  }
  el.innerHTML = `<div class="gsteps">${dots}<span class="glabel">G${step}/${max}</span></div>`;
}

// contadores do histórico
function setHistCounters(rows){
  let w=0,l=0,g=0;
  for(const r of rows||[]){
    if(r.status==='WIN') w++;
    else if(r.status==='LOSS') l++;
    else if(r.status==='GALE') g++;
  }
  const el = $('#hist-counters'); if(el) el.textContent = `W: ${w} • L: ${l} • G: ${g}`;
}

// ===== Banner / Fases =====
function setBannerFrom(openTrade, probs){
  const tgt = openTrade ? openTrade.target : (probs?.rec?.tgt || 'B');
  const pct = openTrade ? probs?.rec?.p : (probs?.rec?.p || 0);

  setSwatchFromTarget(tgt);
  $('#banner-pct').textContent = `${Math.round(pct*10)/10}%`;
  $('#meta-alvo').textContent  = human(tgt);

  if(openTrade){
    $('#live-badge').style.display='inline-block';
    $('#meta-strategy').textContent = openTrade.strategy || '—';
    $('#meta-conf').textContent     = openTrade.confluence ?? '—';
    $('#meta-gales').textContent    = `${openTrade.step||0}/${openTrade.max_gales||0}`;
  }else{
    $('#live-badge').style.display='none';
    $('#meta-strategy').textContent = '—';
    $('#meta-conf').textContent     = '—';
    $('#meta-gales').textContent    = '0/0';
  }
}

function setPhase(openTrade, probs){
  const badge = $('#confirm-badge');
  const ring  = $('#ring');

  if(!openTrade){
    badge.style.display='none';
    ring.className = 'ring ring--idle';
    $('#meta-rec').textContent='—';
    return;
  }

  if(openTrade.phase === 'analyzing'){
    badge.style.display='none';
    ring.className = 'ring ring--idle';
    const pr = probs?.rec ? `${Math.round(probs.rec.p*10)/10}%` : '—%';
    $('#meta-rec').textContent = `Analisando • ${human(probs.rec.tgt)} • ${pr}`;
  }else{
    const g=openTrade.step||0, maxg=openTrade.max_gales||0;
    if(g===0){
      badge.style.display='inline-block';
      ring.className = 'ring ring--open';
      $('#meta-rec').textContent = `Entrada confirmada • ${human(openTrade.target)} • G0 (até ${maxg})`;
    }else{
      badge.style.display='none';
      ring.className = 'ring ring--gale';
      $('#meta-rec').textContent = `Em andamento • ${human(openTrade.target)} • GALE ${g}/${maxg}`;
    }
  }
}

// ===== KPIs =====
function computeKPIs(rows){
  let wins=0,loss=0,gales=0,streak=0,cur=0;
  for(const r of rows||[]){
    if(r.status==='WIN'){wins++; cur = cur>=0 ? cur+1 : 1;}
    if(r.status==='LOSS'){loss++; cur = cur<=0 ? cur-1 : -1;}
    if(r.status==='GALE'){gales += 1;}
    streak = cur;
  }
  const total = wins+loss;
  $('#k-win').textContent   = total? `${Math.round((wins/total)*100)}%` : '—';
  $('#k-gales').textContent = (rows||[]).length? (gales/Math.max(1,(wins+loss))).toFixed(2) : '—';
  $('#k-streak').textContent= streak>0? `+${streak}` : `${streak}`;
}

// ===== Histórico minimal =====
function renderMiniHistory(rows){
  const el = $('#mini-hits');
  const last = (rows||[]).slice(0,22);
  if(!last.length){
    $('#mini-history').classList.add('hide');
    el.innerHTML = '';
    return;
  }
  $('#mini-history').classList.remove('hide');

  const color = s => s==='WIN'  ? 'var(--ok)'
                    : s==='LOSS' ? 'var(--bad)'
                    : s==='GALE' ? 'var(--warn)'
                    : (s==='open'||s==='OPEN') ? '#7aa5ff' : 'var(--muted)';
  const sym   = s => ({ANALYZING:'A', open:'O', OPEN:'O', WIN:'W', GALE:'G', LOSS:'L'})[s] || 'A';

  el.innerHTML = last.map(r=>{
    const c = color(r.status);
    const t = r.target ? `<small style="opacity:.7;margin-left:4px">${r.target}</small>` : '';
    const label = (r.label || r.status || '').toString().replace(/"/g,'&quot;');
    return `<span class="chip-mini" title="${label}">
              <span class="dot" style="background:${c}"></span>
              <span class="lab" style="color:${c}">${sym(r.status)}</span>${t}
            </span>`;
  }).join('');
}

// ===== Estado inicial =====
function clearOnFirstLoad(){
  $('#rolls').innerHTML = '';
  $('#mini-history').classList.add('hide');
  $('#confirm-badge').style.display='none';
  $('#banner-pct').textContent='—%';
  $('#meta-alvo').textContent='—';
  $('#meta-rec').textContent='—';
}

// ===== Loop =====
async function tick(){
  try{
    const res = await fetch(API+'/state');
    const j = await res.json();

    // header
    $('#state-pill').textContent = `${j.bot_on?'ONLINE':'OFFLINE'} • ${j.mode}`;
    setActiveModeButton(j.mode);

    // cooldowns visuais
    renderCooldowns(j.cooldowns.white, j.cooldowns.color);

    // giros
    const hasHistory = (j.last_50||[]).length > 0;
    $('#rolls').innerHTML = hasHistory ? j.last_50.slice(-14).map(n=>ball(n)).join('') : '';

    // aprender tempo de rodada (EMA)
    const len = (j.last_50||[]).length;
    if(len > lastHistLen){
      const now = Date.now();
      const dt = now - lastSpinAt;
      if(dt > 1000 && dt < 40000){ spinMs = 0.7*spinMs + 0.3*dt; }
      lastSpinAt = now;
      lastHistLen = len;
    }

    // banner
    if(hasHistory){
      const probs = { rec:{ tgt:j.probs.rec.tgt, p:j.probs.rec.p } };
      setBannerFrom(j.open_trade, probs);
      setPhase(j.open_trade, probs);
      const q = computeQuality(j.open_trade, probs);
      setQualityBadge(q);
      setGaleUI(j.open_trade);
    }else{
      clearOnFirstLoad();
    }

    // KPIs + histórico
    const sigs = j.signals || [];
    computeKPIs(sigs);
    renderMiniHistory(sigs);
    setHistCounters(sigs);

  }catch(e){
    console.error('state fetch error:', e);
    $('#state-pill').textContent = 'OFFLINE';
  }finally{
    setTimeout(tick, 900);
  }
}

// boot
clearOnFirstLoad();
tick();
</script>
</body>
</html>
