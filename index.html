<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spectra X — Neural Trader (Classic)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0b13;--panel:#111122;--card:#151527;--stroke:#23243a;--text:#eef2ff;--muted:#9aa3b2;--neon:#9f5bff;--neon2:#00b3ff;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;color:var(--text);background:radial-gradient(1000px 500px at -10% -20%, rgba(159,91,255,.15), transparent 60%),radial-gradient(900px 600px at 110% -10%, rgba(0,179,255,.12), transparent 50%),var(--bg)}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:42px;height:42px;border-radius:12px;background:conic-gradient(from 210deg,var(--neon),var(--neon2),var(--neon));box-shadow:0 6px 18px rgba(159,91,255,.35), inset 0 0 12px rgba(0,0,0,.4)}
  .brand h1{font-size:20px;margin:0;font-weight:800}
  .status{display:flex;gap:10px;flex-wrap:wrap}
  .chip{background:linear-gradient(180deg,#171a2b,#0f1120);border:1px solid var(--stroke);border-radius:999px;padding:8px 12px;display:inline-flex;gap:8px;align-items:center;color:#d6dbff}
  main{display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,#151527,#121227);border:1px solid var(--stroke);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 12px 0;font-size:15px;color:#e6e9ff}
  .row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 260px}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(10,1fr);border-radius:14px;border:1px dashed var(--stroke);padding:10px;background:linear-gradient(180deg,#111326,#0c0f1f)}
  .ball{height:34px;border-radius:10px;border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center;font-weight:800;background:linear-gradient(180deg,#0e1123,#0a0d1a);text-shadow:0 0 14px rgba(159,91,255,.35)}
  .b-red{color:#ff7a7a}.b-black{color:#cbd5e1}.b-white{color:#9f5bff;border:1px solid rgba(159,91,255,.6);box-shadow:0 0 18px rgba(159,91,255,.35), inset 0 0 10px rgba(159,91,255,.15)}
  .progress{height:12px;background:#0c0f1f;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--neon),var(--neon2));box-shadow:0 0 14px rgba(159,91,255,.45)}
  .tag{font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--stroke);font-size:13px} th{text-align:left;color:#b9c3ff} tr:last-child td{border-bottom:none}
  .pill{display:inline-flex;align-items:center;padding:6px 14px;border-radius:999px;background:#0e1021;border:1px solid var(--stroke);gap:8px;font-weight:800}
  button{width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:900;letter-spacing:.2px;background:linear-gradient(135deg,rgba(159,91,255,.95),rgba(0,179,255,.9));color:#fff;box-shadow:0 10px 30px rgba(0,179,255,.18),0 0 0 1px rgba(255,255,255,.04) inset}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:700px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{background:linear-gradient(180deg,#12132a,#0d1022);border:1px solid var(--stroke);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .kpi .v{font-size:22px;font-weight:900}.kpi .l{font-size:12px;color:var(--muted)}
  .bigBadge{font-size:28px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="logo"></div><h1>Spectra X — Neural Trader (Classic)</h1></div>
    <div class="status">
      <span class="chip">API: <b id="apiStatus">Online</b></span>
      <span class="chip">Stake: R$ <b id="stakeLabel">2.00</b></span>
      <span class="chip">Gales: <b id="galesLabel">2</b></span>
      <span class="chip">Winrate: <b id="wrLabel">0%</b></span>
    </div>
  </header>

  <main>
    <section class="card col">
      <h2>Últimas Rodadas & Probabilidades</h2>
      <div class="grid" id="lastGrid"></div>
      <div style="margin-top:12px" class="row">
        <div class="col"><div class="pill">Red prob</div><div class="progress"><i id="pRed"></i></div><span class="tag" id="pRedTxt">0%</span></div>
        <div class="col"><div class="pill">Black prob</div><div class="progress"><i id="pBlack"></i></div><span class="tag" id="pBlackTxt">0%</span></div>
        <div class="col"><div class="pill">White prob</div><div class="progress"><i id="pWhite"></i></div><span class="tag" id="pWhiteTxt">0%</span></div>
      </div>
      <div style="margin-top:12px" class="kpis">
        <div class="kpi"><div class="v" id="sigTotal">0</div><div class="l">Sinais</div></div>
        <div class="kpi"><div class="v" id="wins">0</div><div class="l">Wins</div></div>
        <div class="kpi"><div class="v" id="losses">0</div><div class="l">Losses</div></div>
        <div class="kpi"><div class="v" id="bank">R$ 0,00</div><div class="l">Resultado</div></div>
      </div>
    </section>

    <section class="card col">
      <h2>Entrada Recomendada</h2>
      <div id="entryBox" style="display:flex;flex-direction:column;gap:12px">
        <div class="pill bigBadge" id="entryBadge">—</div>
        <div>
          <div class="progress"><i id="entryBar"></i></div>
          <span class="tag" id="entryConf">confiança: 0%</span>
        </div>
        <button id="confirmBtn" disabled>Confirmar entrada (Enter)</button>
        <div class="row" style="margin-top:6px">
          <div class="col"><div class="kpi"><div class="v" id="sigGale">—</div><div class="l">Gale (atual / máx)</div></div></div>
          <div class="col"><div class="kpi"><div class="v" id="sigStatus">—</div><div class="l">Status</div></div></div>
        </div>
      </div>
    </section>

    <section class="card col" style="grid-column:1 / -1">
      <h2>Histórico de Operações</h2>
      <table>
        <thead><tr><th>Horário</th><th>Entrada</th><th>Confiança</th><th>Gales</th><th>Resultado</th></tr></thead>
        <tbody id="opsBody"></tbody>
      </table>
    </section>
  </main>
</div>

<script>
  const $=(id)=>document.getElementById(id);
  const money=v=>"R$ "+(v||0).toFixed(2).replace(".",",");

  async function j(url,opts){const r=await fetch(url,opts);return await r.json();}

  function renderBalls(arr){
    const g=$("lastGrid"); g.innerHTML="";
    arr.slice(-10).forEach(c=>{
      const b=document.createElement("div");
      b.className="ball "+(c==="red"?"b-red":c==="black"?"b-black":"b-white");
      b.textContent=c==="white"?"W":(c==="red"?"R":"B");
      g.appendChild(b);
    });
  }

  function setEntry(color, conf, gale, maxg, status, confirmed){
    const badge=$("entryBadge");
    if(!color){ badge.textContent="—"; $("entryBar").style.width="0%"; $("entryConf").textContent="confiança: 0%"; $("confirmBtn").disabled=true; $("sigGale").textContent="—"; $("sigStatus").textContent="—"; return; }
    const label = color.toUpperCase();
    badge.textContent = `ENTRAR: ${label}`;
    badge.style.borderColor = color==="white"?"#9f5bff":(color==="red"?"#ef4444":"#cbd5e1");
    $("entryBar").style.width = Math.round(conf*100)+"%";
    $("entryConf").textContent = "confiança: "+Math.round(conf*100)+"%";
    $("sigGale").textContent = (gale||0)+"/"+(maxg||0);
    $("sigStatus").textContent = confirmed ? "confirmado" : (status || "—");
    $("confirmBtn").disabled = confirmed || status!=="running";
    $("confirmBtn").textContent = confirmed ? "Confirmado ✓" : "Confirmar entrada (Enter)";
  }

  function row(op){
    const tr=document.createElement("tr");
    const t=new Date(op.created_at||Date.now()).toLocaleTimeString();
    tr.innerHTML=`<td>${t}</td><td><span class="pill">${(op.color||"").toUpperCase()}</span></td>
      <td>${((op.confidence||0)*100).toFixed(0)}%</td><td>${op.gale_step||0}/${op.max_gales||0}</td>
      <td>${op.result ? (op.result==="WIN"?"✅ WIN":"❌ LOSS") : (op.confirmed?"✓ Confirmado":"—")}</td>`;
    return tr;
  }
  let lastFinishedId=null;
  function maybeAppendFinished(op){
    if(!op||!op.result)return;
    const id=op.created_at;
    if(id && id!==lastFinishedId){$("opsBody").prepend(row(op)); lastFinishedId=id;}
  }

  async function refresh(){
    try{
      const s=await j(`/api/state`);
      $("stakeLabel").textContent=(s.config.stake||0).toFixed(2);
      $("galesLabel").textContent=s.config.max_gales;
      $("sigTotal").textContent=s.metrics.total_signals||0;
      $("wins").textContent=s.metrics.wins||0;
      $("losses").textContent=s.metrics.losses||0;
      $("bank").textContent=money(s.metrics.bank_result||0);
      $("wrLabel").textContent=Math.round((s.metrics.winrate||0)*100)+"%";
      renderBalls(s.history_tail||[]);

      const a=s.active_signal;
      if(a){ setEntry(a.color,a.confidence,a.gale_step,a.max_gales,a.status,a.confirmed); if(a.status==="finished"){ maybeAppendFinished(a);} }
      else{ setEntry(null,0,0,0,"—",false); }

      $("apiStatus").textContent="Online";
    }catch(e){$("apiStatus").textContent="Offline";}
  }

  async function confirmEntry(){
    try{
      const r=await j(`/api/confirm`,{method:"POST"});
      if(r.ok){ refresh(); }
    }catch(e){}
  }

  $("confirmBtn").onclick=confirmEntry;
  // atalho: Enter
  window.addEventListener("keydown",e=>{ if(e.key==="Enter" && !$("confirmBtn").disabled){ confirmEntry(); } });

  refresh(); setInterval(refresh,1000);
</script>
</body>
</html>
