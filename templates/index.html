<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SNIPER BLAZE â€” Neural Trader</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b13; --panel:#111122; --glass:#15152a; --card:#151527;
      --muted:#9aa3b2; --text:#eef2ff; --stroke:#23243a;
      --neon:#9f5bff; --neon2:#00b3ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --chip:#151536; --white:#f7f7f7; --black:#0f1117; --red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font:400 14px/1.5 Inter,system-ui,Arial;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(159,91,255,.12), transparent 60%),
        radial-gradient(900px 700px at 120% 10%, rgba(0,179,255,.10), transparent 60%),
        var(--bg);
      letter-spacing:.15px;
    }
    .wrap{max-width:1280px;margin:22px auto;padding:0 16px}
    h1{margin:0;font-size:18px;letter-spacing:.6px}
    .row{display:grid;gap:16px}
    .g3{grid-template-columns:2fr 1.2fr 1fr}
    @media (max-width:1080px){.g3{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
           border:1px solid var(--stroke);border-radius:16px;padding:14px;backdrop-filter:blur(6px)}
    .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .kpi{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--stroke);padding:6px 10px;border-radius:999px;font-weight:700}
    .btn{background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:0;color:#fff;font-weight:800;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:var(--text);font-weight:700}
    .seg{display:flex;border:1px solid var(--stroke);border-radius:10px;overflow:hidden}
    .seg button{background:transparent;color:var(--text);padding:8px 12px;border:0;cursor:pointer}
    .seg button.active{background:var(--neon);color:#0c0c12;font-weight:800}

    /* Banner IA */
    .neural-banner{
      display:grid;grid-template-columns:1.2fr 1fr;gap:14px;align-items:center;
      border:1px solid var(--stroke);border-radius:16px;padding:16px;background:linear-gradient(180deg, rgba(159,91,255,.06), rgba(0,0,0,0));
      position:relative; overflow:hidden;
    }
    .neural-banner:before{
      content:"";position:absolute;inset:-2px;pointer-events:none;
      background: radial-gradient(500px 300px at 20% -40%, rgba(159,91,255,.12), transparent 60%),
                  radial-gradient(600px 300px at 120% 120%, rgba(0,179,255,.10), transparent 60%);
      filter: blur(0.2px);
    }
    .live{position:absolute;top:10px;right:10px;background:var(--ok);color:#06130a;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;animation:pulse 1.4s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.45}100%{opacity:1}}

    .brain{
      width:100%;aspect-ratio:1/1;display:grid;place-items:center;position:relative;
      border-radius:50%;
      background:radial-gradient(closest-side, rgba(159,91,255,.18), transparent 70%);
    }
    .ring{
      position:absolute;inset:8%;border-radius:50%;
      background:
        conic-gradient(from 90deg, var(--neon), var(--neon2), var(--neon), var(--neon2));
      -webkit-mask:radial-gradient(farthest-side, transparent calc(100% - 8px), #000 calc(100% - 8px));
              mask:radial-gradient(farthest-side, transparent calc(100% - 8px), #000 calc(100% - 8px));
      animation:spin 9s linear infinite;
      filter:drop-shadow(0 0 10px rgba(159,91,255,.35));
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .brain-core{position:relative;z-index:2;text-align:center}
    .brain-core .tgt{font-size:28px;font-weight:800;letter-spacing:.5px}
    .brain-core .pct{font-size:18px;opacity:.9}
    .grid-mini{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .chip2{background:#0f1020;border:1px solid var(--stroke);padding:8px 10px;border-radius:10px}
    .chip2 b{font-size:16px}

    .meta{display:grid;gap:10px}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .tag{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);font-size:12px}
    .muted{color:var(--muted)}
    .bar{height:8px;border-radius:999px;background:#20223a;overflow:hidden;border:1px solid var(--stroke)}
    .bar>span{display:block;height:100%}
    .bar.white>span{background:#e5e7eb}
    .bar.red>span{background:#ef4444}
    .bar.black>span{background:#0b0f14}

    .scroll{display:flex;gap:8px;overflow:auto;padding:6px 2px}
    .ball{min-width:46px;height:46px;border-radius:12px;display:grid;place-items:center;font-weight:800;border:1px solid var(--stroke)}
    .ball.R{background:#ff2740}
    .ball.B{background:#0f1117}
    .ball.W{background:#ffffff;color:#111;border-color:#ddd}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--stroke);padding:10px 6px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .warn{color:var(--warn);font-weight:800}

    /* KPI strip */
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .k-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
    .k-title{font-size:12px;color:var(--muted)}
    .k-value{font-size:18px;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER -->
    <div class="panel">
      <div class="title">
        <h1>SNIPER BLAZE â€” Neural Trader</h1>
        <div class="kpi">
          <span class="chip" id="state-pill">OFFLINE</span>
          <div class="seg">
            <button class="active" id="mode-cores">CORES</button>
            <button id="mode-branco">BRANCO</button>
          </div>
          <button class="btn" id="btn-start">Iniciar</button>
          <button class="btn ghost" id="btn-stop">Parar</button>
          <!-- ajustes rÃ¡pidos -->
          <span class="chip" title="mÃ­n confluÃªncia branco">
            W: <input id="inp-conf-white" type="number" min="1" value="2" style="width:48px;background:transparent;border:0;color:var(--text);text-align:center">
          </span>
          <span class="chip" title="mÃ­n confluÃªncia cores">
            C: <input id="inp-conf-color" type="number" min="1" value="2" style="width:48px;background:transparent;border:0;color:var(--text);text-align:center">
          </span>
          <span class="chip" title="perfil de risco">
            Risco:
            <select id="sel-risk" style="background:transparent;border:0;color:var(--text)">
              <option value="conservador">Conservador</option>
              <option value="agressivo">Agressivo</option>
            </select>
          </span>
          <button class="btn ghost" id="btn-save-conf">Aplicar</button>
        </div>
      </div>
    </div>

    <!-- GRID -->
    <div class="row g3" style="margin-top:14px">

      <!-- COL 1: Banner IA + KPIs -->
      <div class="panel">
        <div class="title"><strong>Motor IA â€” PrÃ³xima Entrada</strong><span class="muted" id="cooldowns">â€”</span></div>

        <div id="banner" class="neural-banner">
          <div class="live" id="live-badge" style="display:none">LIVE</div>

          <!-- cÃ©rebro IA -->
          <div class="brain">
            <div class="ring"></div>
            <div class="brain-core">
              <div class="tgt" id="banner-tgt">â€”</div>
              <div class="pct" id="banner-pct">â€”%</div>
              <div class="grid-mini" style="margin-top:10px">
                <div class="chip2">âšª Branco<br><b id="w-val">0%</b></div>
                <div class="chip2">ðŸ”´ Vermelho<br><b id="r-val">0%</b></div>
                <div class="chip2">âš« Preto<br><b id="b-val">0%</b></div>
              </div>
            </div>
          </div>

          <!-- meta da entrada -->
          <div class="meta">
            <div class="meta-row">
              <span class="tag">Alvo</span>
              <b id="meta-alvo">â€”</b>
            </div>
            <div class="meta-row">
              <span class="tag">EstratÃ©gia</span>
              <b id="meta-strategy">â€”</b>
            </div>
            <div class="meta-row">
              <span class="tag">ConfluÃªncia</span>
              <b id="meta-conf">â€”</b>
            </div>
            <div class="meta-row">
              <span class="tag">Gales</span>
              <b id="meta-gales">0/0</b>
            </div>
            <div class="meta-row">
              <span class="tag">RecomendaÃ§Ã£o</span>
              <b id="meta-rec">â€”</b>
            </div>
          </div>
        </div>

        <!-- KPIs rÃ¡pidos -->
        <div class="kpis">
          <div class="k-card"><div class="k-title">WinRate (sessÃ£o)</div><div class="k-value" id="k-win">â€”</div></div>
          <div class="k-card"><div class="k-title">Gales mÃ©dios</div><div class="k-value" id="k-gales">â€”</div></div>
          <div class="k-card"><div class="k-title">SequÃªncia atual</div><div class="k-value" id="k-streak">â€”</div></div>
        </div>
      </div>

      <!-- COL 2: Ãšltimos giros -->
      <div class="panel">
        <div class="title"><strong>Ãšltimos giros</strong></div>
        <div id="rolls" class="scroll"></div>
        <div class="card" style="margin-top:12px">
          <div class="title"><strong>Chances da rodada (barras)</strong></div>
          <div class="bar white"><span id="bar-w" style="width:0%"></span></div>
          <div class="bar red"  style="margin-top:8px"><span id="bar-r" style="width:0%"></span></div>
          <div class="bar black" style="margin-top:8px"><span id="bar-b" style="width:0%"></span></div>
        </div>
      </div>

      <!-- COL 3: HistÃ³rico -->
      <div class="panel">
        <div class="title"><strong>HistÃ³rico de Sinais</strong></div>
        <div class="card" style="max-height:520px;overflow:auto">
          <table>
            <thead><tr>
              <th>Hora</th><th>Modo</th><th>Alvo</th><th>RÃ³tulo</th><th>EstratÃ©gia</th><th>Conf.</th><th>Status</th><th>Gale</th><th>Saiu</th>
            </tr></thead>
            <tbody id="log"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API = location.origin;
    const $ = s => document.querySelector(s);

    // ======== Controles ========
    $('#mode-cores').onclick = async () => {
      $('#mode-cores').classList.add('active');
      $('#mode-branco').classList.remove('active');
      await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'CORES'})});
    };
    $('#mode-branco').onclick = async () => {
      $('#mode-branco').classList.add('active');
      $('#mode-cores').classList.remove('active');
      await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'BRANCO'})});
    };
    $('#btn-start').onclick = async () => {
      await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:true})});
    };
    $('#btn-stop').onclick = async () => {
      await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bot_on:false})});
    };
    $('#btn-save-conf').onclick = async () => {
      const cw = parseInt($('#inp-conf-white').value||'2',10);
      const cc = parseInt($('#inp-conf-color').value||'2',10);
      const risk = $('#sel-risk').value;
      await fetch(API+'/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confluence_white:cw,confluence_color:cc,risk})});
    };

    // ======== UI helpers ========
    function ball(n){
      if(n===0) return `<div class="ball W">0</div>`;
      const c = (n>=1 && n<=7) ? 'R' : 'B';
      return `<div class="ball ${c}">${n}</div>`;
    }
    function setBars(W,R,B){
      $('#w-val').textContent = `${W}%`; $('#r-val').textContent = `${R}%`; $('#b-val').textContent = `${B}%`;
      $('#bar-w').style.width = W+'%'; $('#bar-r').style.width = R+'%'; $('#bar-b').style.width = B+'%';
    }
    function setBanner(prob, openTrade){
      const name = t => t==='W'?'Branco':(t==='R'?'Vermelho':'Preto');
      $('#banner-tgt').textContent = name(prob.rec.tgt);
      $('#banner-pct').textContent = `${Math.round(prob.rec.p*10)/10}%`;
      $('#meta-alvo').textContent = name(prob.rec.tgt);
      $('#meta-rec').textContent = `${name(prob.rec.tgt)} â€¢ ${Math.round(prob.rec.p*10)/10}%`;

      // Prob chips
      $('#w-val').textContent = `${Math.round(prob.W*1000)/10}%`;
      $('#r-val').textContent = `${Math.round(prob.R*1000)/10}%`;
      $('#b-val').textContent = `${Math.round(prob.B*1000)/10}%`;

      // live + trade info
      if(openTrade){
        $('#live-badge').style.display='inline-block';
        $('#meta-strategy').textContent = openTrade.strategy || 'â€”';
        $('#meta-conf').textContent = openTrade.confluence ?? 'â€”';
        $('#meta-gales').textContent = `${openTrade.step||0}/${openTrade.max_gales||0}`;
      }else{
        $('#live-badge').style.display='none';
        $('#meta-strategy').textContent = 'â€”';
        $('#meta-conf').textContent = 'â€”';
        $('#meta-gales').textContent = '0/0';
      }
    }
    function setLog(rows){
      const mapName = v => v==='W'?'âšª':(v==='R'?'ðŸ”´':'âš«');
      $('#log').innerHTML = (rows||[]).map(r=>{
        const stClass = r.status==='WIN'?'ok':(r.status==='LOSS'?'bad':(r.status==='GALE'?'warn':'')); 
        return `
          <tr class="${stClass}">
            <td>${r.ts||'-'}</td>
            <td>${r.mode||'-'}</td>
            <td>${mapName(r.target)}</td>
            <td>${r.label||'-'}</td>
            <td>${r.strategy||'-'}</td>
            <td>${r.confluence ?? '-'}</td>
            <td class="${stClass}">${(r.status||'-').toUpperCase()}</td>
            <td>${r.gale ?? '-'}</td>
            <td>${r.came ?? '-'}</td>
          </tr>`;
      }).join('');
    }

    // KPIs derivadas do log
    function computeKPIs(rows){
      let wins=0,loss=0,gales=0,streak=0,cur=0;
      for(const r of rows||[]){
        if(r.status==='WIN'){wins++; cur = cur>=0 ? cur+1 : 1;}
        if(r.status==='LOSS'){loss++; cur = cur<=0 ? cur-1 : -1;}
        if(r.status==='GALE'){gales += 1;}
        streak = cur;
      }
      const total = wins+loss;
      $('#k-win').textContent = total? `${Math.round((wins/total)*100)}%` : 'â€”';
      $('#k-gales').textContent = (rows||[]).length? (gales/Math.max(1,(wins+loss))).toFixed(2) : 'â€”';
      $('#k-streak').textContent = streak>0? `+${streak}` : `${streak}`;
    }

    // beep discreto
    const beep = (freq=740, ms=120) => {
      try{
        const a = new (window.AudioContext||window.webkitAudioContext)();
        const o = a.createOscillator(); const g = a.createGain();
        o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(a.destination);
        g.gain.setValueAtTime(0.001,a.currentTime); g.gain.exponentialRampToValueAtTime(0.2,a.currentTime+0.01);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001,a.currentTime+ms/1000); o.stop(a.currentTime+ms/1000);
      }catch(e){}
    };
    let lastTopStatus = "";

    // ======== Loop ========
    async function tick(){
      try{
        const res = await fetch(API+'/state'); const j = await res.json();

        // estado
        $('#state-pill').textContent = `${j.bot_on?'ONLINE':'OFFLINE'} â€¢ ${j.mode}`;
        // roll chips
        $('#rolls').innerHTML = (j.last_50||[]).slice(-14).map(n=>ball(n)).join('');
        // probs/barras
        setBars(j.probs.W, j.probs.R, j.probs.B);
        // banner
        setBanner({W:j.probs.W/100,R:j.probs.R/100,B:j.probs.B/100,rec:[j.probs.rec.tgt,j.probs.rec.p/100].reduce((a,b)=>({tgt:a, p:b}))}, j.open_trade); // helper para manter compat.
        // cooldowns
        $('#cooldowns').textContent = `cooldown â€¢ branco ${j.cooldowns.white}, cores ${j.cooldowns.color}`;
        // log + KPIs
        setLog(j.signals || []);
        computeKPIs(j.signals || []);

        // beep na transiÃ§Ã£o de GALE/WIN
        const top = (j.signals||[])[0];
        const key = top ? `${top.status}-${top.gale}-${top.ts}` : '';
        if(key && key!==lastTopStatus){
          if(top.status==='GALE') beep(520,140);
          if(top.status==='WIN')  beep(880,160);
          if(top.status==='LOSS') beep(380,180);
          lastTopStatus = key;
        }

        // preencher controles de confluÃªncia/risco
        if(j.confluence){
          $('#inp-conf-white').value = j.confluence.white_min ?? 2;
          $('#inp-conf-color').value = j.confluence.color_min ?? 2;
          $('#sel-risk').value = j.confluence.selecao_risco || 'conservador';
        }
      }catch(e){
        console.error(e);
        $('#state-pill').textContent = 'OFFLINE';
      }finally{
        setTimeout(tick, 900);
      }
    }
    tick();
  </script>
</body>
</html>
